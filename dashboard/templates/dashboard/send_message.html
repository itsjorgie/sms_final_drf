<!-- send_message.html -->

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Message</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <h2>Send Message</h2>
    <form id="sendMessageFormElement" method="POST" action="{% url 'send_message' %}">
        {% csrf_token %}
        <label for="message">Message</label>
        <textarea name="message" rows="5" required></textarea><br>
    
        <button type="submit">Send</button>
    </form>
</body>

    <script>
        // Send message
function sendMessage(event) {
    event.preventDefault(); // Prevent form submission

    // Get the form data
    const formData = new FormData(document.getElementById("sendMessageFormElement"));
    const data = {
        message: formData.get("message"),  // Get the message content from the form
    };

    // Get the CSRF token
    const csrfToken = formData.get("csrfmiddlewaretoken");

    // Get the authentication token from localStorage
    const token = localStorage.getItem("access_token");
    if (!token) {
        alert("You need to log in first.");
        window.location.href = "/login"; // Redirect to the login page
        return;
    }

    // Determine the system to decide which URL to use
    const system = getCurrentSystem();
    const sendUrl = system === "system1"
        ? "http://127.0.0.1:8001/api/system1/send/"
        : "http://127.0.0.1:8002/api/system2/send/";

    // Send the data to the backend using Fetch API
    fetch(sendUrl, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,  // Bearer token for authentication
            "X-CSRFToken": csrfToken  // CSRF token from the form
        },
        body: JSON.stringify(data)  // Send message data in the body
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Failed to send message: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.message) {
            alert("Message sent successfully!");
            document.getElementById("sendMessageFormElement").reset(); // Clear the form after sending
        } else {
            alert("Failed to send message.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("An error occurred while sending the message.");
    });
}

// Add event listener to form submit
document.getElementById("sendMessageFormElement").addEventListener("submit", sendMessage);

    </script>
</html>
