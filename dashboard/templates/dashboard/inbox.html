{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <h2>Your Inbox</h2>

    {% if messages %}
        <ul>
            {% for message in messages %}
                <li>
                    <strong>{{ message.timestamp }}</strong>
                    <p>{{ message.message }}</p>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No messages received yet.</p>
    {% endif %}
</body>

<script>// Show section
    function showSection(sectionId) {
        const sections = document.querySelectorAll("main > div");
        sections.forEach(section => section.style.display = "none");
    
        const selectedSection = document.getElementById(sectionId);
        if (selectedSection) {
            selectedSection.style.display = "block";
        }
    }
    
    // Determine the current system based on the URL
    function getCurrentSystem() {
        const currentUrl = window.location.href;
        if (currentUrl.includes("8001")) {
            return "system1";
        } else if (currentUrl.includes("8002")) {
            return "system2";
        }
        return null;
    }
    
    // Show inbox and fetch messages based on the current system
    function showInbox() {
        const system = getCurrentSystem();
        if (!system) {
            alert("Unable to determine the system.");
            return;
        }
        fetchReceivedMessages(system);
        showSection("receivedMessagesForm");
    }
    
    // Fetch received messages
    function fetchReceivedMessages(system) {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("You need to log in first.");
            window.location.href = "/inbox"; // Redirect to login page
            return;
        }
    
        const receiveUrl = system === "system1"
            ? "http://127.0.0.1:8001/api/system1/received/"
            : "http://127.0.0.1:8002/api/system2/received/";
    
        fetch(receiveUrl, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to fetch messages: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            const messageList = document.getElementById("receivedMessagesList");
            messageList.innerHTML = ""; // Clear any previous messages
    
            if (Array.isArray(data) && data.length === 0) {
                const noMessagesItem = document.createElement("li");
                noMessagesItem.textContent = "No messages received yet.";
                messageList.appendChild(noMessagesItem);
            } else {
                data.forEach(msg => {
                    const listItem = document.createElement("li");
                    listItem.textContent = msg.message;
                    messageList.appendChild(listItem);
                });
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("An error occurred while fetching received messages.");
        });
    }
    </script>
</html>
